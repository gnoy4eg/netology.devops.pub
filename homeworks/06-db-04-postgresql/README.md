# Домашнее задание к занятию "6.4. PostgreSQL"

## Задача 1

Используя docker поднимите инстанс PostgreSQL (версию 13). Данные БД сохраните в volume.

Подключитесь к БД PostgreSQL используя `psql`.

Воспользуйтесь командой `\?` для вывода подсказки по имеющимся в `psql` управляющим командам.

**Найдите и приведите** управляющие команды для:
- вывода списка БД
- подключения к БД
- вывода списка таблиц
- вывода описания содержимого таблиц
- выхода из psql

Ответ:  
ДЗ буду делать в облаке Яндекса. Промежуточные результаты буду прятать под спойлер.


<details>
  <summary>Console</summary>

Создаем временную подсеть, билдим образ системы, удаляем временную подсеть, проверяем наличие робота, созданный image, генерируем key.json для Terraform'а
```bash
[gnoy@manjarokde-ws01 packer]$ yc vpc network create --name net --labels my-label=netology --description "my build network via yc" && yc vpc subnet create --name my-subnet-a --zone ru-central1-a --range 10.1.2.0/24 --network-name net --description "my build subnet via yc"
id: enplguu8t6nqraj8upp2
folder_id: b1g27gpcstr1l1bi3a22
created_at: "2022-02-15T10:55:00Z"
name: net
description: my build network via yc
labels:
  my-label: netology

id: e9b3hea97tekhsgsg754
folder_id: b1g27gpcstr1l1bi3a22
created_at: "2022-02-15T10:55:02Z"
name: my-subnet-a
description: my build subnet via yc
network_id: enplguu8t6nqraj8upp2
zone_id: ru-central1-a
v4_cidr_blocks:
- 10.1.2.0/24

[gnoy@manjarokde-ws01 packer]$ packer validate centos-7-base.json.pkr.hcl 
The configuration is valid.
[gnoy@manjarokde-ws01 packer]$ packer build centos-7-base.json.pkr.hcl 
yandex.autogenerated_1: output will be in this color.

==> yandex.autogenerated_1: Creating temporary RSA SSH key for instance...
==> yandex.autogenerated_1: Using as source image: fd82n2d2h9fet9648lej (name: "centos-7-v20220214", family: "centos-7")
==> yandex.autogenerated_1: Use provided subnet id e9b3hea97tekhsgsg754
==> yandex.autogenerated_1: Creating disk...
==> yandex.autogenerated_1: Creating instance...
==> yandex.autogenerated_1: Waiting for instance with id fhm9a30a18gh5f36vqcl to become active...
    yandex.autogenerated_1: Detected instance IP: 62.84.126.154
==> yandex.autogenerated_1: Using SSH communicator to connect: 62.84.126.154
==> yandex.autogenerated_1: Waiting for SSH to become available...
==> yandex.autogenerated_1: Connected to SSH!
==> yandex.autogenerated_1: Provisioning with shell script: /tmp/packer-shell1050057154
    yandex.autogenerated_1: Loaded plugins: fastestmirror
    yandex.autogenerated_1: Loading mirror speeds from cached hostfile
    yandex.autogenerated_1:  * base: mirror.reconn.ru
    yandex.autogenerated_1:  * extras: mirror.reconn.ru
    yandex.autogenerated_1:  * updates: centos-mirror.rbc.ru
    yandex.autogenerated_1: No packages marked for update
    yandex.autogenerated_1: Loaded plugins: fastestmirror
    yandex.autogenerated_1: Loading mirror speeds from cached hostfile
    yandex.autogenerated_1:  * base: mirror.reconn.ru
    yandex.autogenerated_1:  * extras: centos-mirror.rbc.ru
    yandex.autogenerated_1:  * updates: centos-mirror.rbc.ru
    yandex.autogenerated_1: Package iptables-1.4.21-35.el7.x86_64 already installed and latest version
    yandex.autogenerated_1: Package curl-7.29.0-59.el7_9.1.x86_64 already installed and latest version
    yandex.autogenerated_1: Package net-tools-2.0-0.25.20131004git.el7.x86_64 already installed and latest version
    yandex.autogenerated_1: Package rsync-3.1.2-10.el7.x86_64 already installed and latest version
    yandex.autogenerated_1: Package openssh-server-7.4p1-22.el7_9.x86_64 already installed and latest version
    yandex.autogenerated_1: Resolving Dependencies
    yandex.autogenerated_1: --> Running transaction check
    yandex.autogenerated_1: ---> Package bind-utils.x86_64 32:9.11.4-26.P2.el7_9.8 will be installed
    yandex.autogenerated_1: --> Processing Dependency: bind-libs-lite(x86-64) = 32:9.11.4-26.P2.el7_9.8 for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: bind-libs(x86-64) = 32:9.11.4-26.P2.el7_9.8 for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: liblwres.so.160()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libisccfg.so.160()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libisc.so.169()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libirs.so.160()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libdns.so.1102()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libbind9.so.160()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libGeoIP.so.1()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: ---> Package bridge-utils.x86_64 0:1.5-9.el7 will be installed
    yandex.autogenerated_1: ---> Package tcpdump.x86_64 14:4.9.2-4.el7_7.1 will be installed
    yandex.autogenerated_1: --> Processing Dependency: libpcap >= 14:1.5.3-10 for package: 14:tcpdump-4.9.2-4.el7_7.1.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libpcap.so.1()(64bit) for package: 14:tcpdump-4.9.2-4.el7_7.1.x86_64
    yandex.autogenerated_1: ---> Package telnet.x86_64 1:0.17-66.el7 will be installed
    yandex.autogenerated_1: --> Running transaction check
    yandex.autogenerated_1: ---> Package GeoIP.x86_64 0:1.5.0-14.el7 will be installed
    yandex.autogenerated_1: --> Processing Dependency: geoipupdate for package: GeoIP-1.5.0-14.el7.x86_64
    yandex.autogenerated_1: ---> Package bind-libs.x86_64 32:9.11.4-26.P2.el7_9.8 will be installed
    yandex.autogenerated_1: --> Processing Dependency: bind-license = 32:9.11.4-26.P2.el7_9.8 for package: 32:bind-libs-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: ---> Package bind-libs-lite.x86_64 32:9.11.4-26.P2.el7_9.8 will be installed
    yandex.autogenerated_1: ---> Package libpcap.x86_64 14:1.5.3-12.el7 will be installed
    yandex.autogenerated_1: --> Running transaction check
    yandex.autogenerated_1: ---> Package bind-license.noarch 32:9.11.4-26.P2.el7_9.8 will be installed
    yandex.autogenerated_1: ---> Package geoipupdate.x86_64 0:2.5.0-1.el7 will be installed
    yandex.autogenerated_1: --> Finished Dependency Resolution
    yandex.autogenerated_1:
    yandex.autogenerated_1: Dependencies Resolved
    yandex.autogenerated_1:
    yandex.autogenerated_1: ================================================================================
    yandex.autogenerated_1:  Package            Arch       Version                        Repository   Size
    yandex.autogenerated_1: ================================================================================
    yandex.autogenerated_1: Installing:
    yandex.autogenerated_1:  bind-utils         x86_64     32:9.11.4-26.P2.el7_9.8        updates     261 k
    yandex.autogenerated_1:  bridge-utils       x86_64     1.5-9.el7                      base         32 k
    yandex.autogenerated_1:  tcpdump            x86_64     14:4.9.2-4.el7_7.1             base        422 k
    yandex.autogenerated_1:  telnet             x86_64     1:0.17-66.el7                  updates      64 k
    yandex.autogenerated_1: Installing for dependencies:
    yandex.autogenerated_1:  GeoIP              x86_64     1.5.0-14.el7                   base        1.5 M
    yandex.autogenerated_1:  bind-libs          x86_64     32:9.11.4-26.P2.el7_9.8        updates     157 k
    yandex.autogenerated_1:  bind-libs-lite     x86_64     32:9.11.4-26.P2.el7_9.8        updates     1.1 M
    yandex.autogenerated_1:  bind-license       noarch     32:9.11.4-26.P2.el7_9.8        updates      91 k
    yandex.autogenerated_1:  geoipupdate        x86_64     2.5.0-1.el7                    base         35 k
    yandex.autogenerated_1:  libpcap            x86_64     14:1.5.3-12.el7                base        139 k
    yandex.autogenerated_1:
    yandex.autogenerated_1: Transaction Summary
    yandex.autogenerated_1: ================================================================================
    yandex.autogenerated_1: Install  4 Packages (+6 Dependent packages)
    yandex.autogenerated_1:
    yandex.autogenerated_1: Total download size: 3.8 M
    yandex.autogenerated_1: Installed size: 9.0 M
    yandex.autogenerated_1: Downloading packages:
    yandex.autogenerated_1: --------------------------------------------------------------------------------
    yandex.autogenerated_1: Total                                               13 MB/s | 3.8 MB  00:00
    yandex.autogenerated_1: Running transaction check
    yandex.autogenerated_1: Running transaction test
    yandex.autogenerated_1: Transaction test succeeded
    yandex.autogenerated_1: Running transaction
    yandex.autogenerated_1:   Installing : 32:bind-license-9.11.4-26.P2.el7_9.8.noarch                 1/10
    yandex.autogenerated_1:   Installing : geoipupdate-2.5.0-1.el7.x86_64                              2/10
    yandex.autogenerated_1:   Installing : GeoIP-1.5.0-14.el7.x86_64                                   3/10
    yandex.autogenerated_1:   Installing : 32:bind-libs-lite-9.11.4-26.P2.el7_9.8.x86_64               4/10
    yandex.autogenerated_1:   Installing : 32:bind-libs-9.11.4-26.P2.el7_9.8.x86_64                    5/10
    yandex.autogenerated_1:   Installing : 14:libpcap-1.5.3-12.el7.x86_64                              6/10
    yandex.autogenerated_1: pam_tally2: Error opening /var/log/tallylog for update: Permission denied
    yandex.autogenerated_1: pam_tally2: Authentication error
    yandex.autogenerated_1: useradd: failed to reset the tallylog entry of user "tcpdump"
    yandex.autogenerated_1:   Installing : 14:tcpdump-4.9.2-4.el7_7.1.x86_64                           7/10
    yandex.autogenerated_1:   Installing : 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64                   8/10
    yandex.autogenerated_1:   Installing : bridge-utils-1.5-9.el7.x86_64                               9/10
    yandex.autogenerated_1:   Installing : 1:telnet-0.17-66.el7.x86_64                                10/10
    yandex.autogenerated_1:   Verifying  : GeoIP-1.5.0-14.el7.x86_64                                   1/10
    yandex.autogenerated_1:   Verifying  : 1:telnet-0.17-66.el7.x86_64                                 2/10
    yandex.autogenerated_1:   Verifying  : 14:libpcap-1.5.3-12.el7.x86_64                              3/10
    yandex.autogenerated_1:   Verifying  : geoipupdate-2.5.0-1.el7.x86_64                              4/10
    yandex.autogenerated_1:   Verifying  : 14:tcpdump-4.9.2-4.el7_7.1.x86_64                           5/10
    yandex.autogenerated_1:   Verifying  : 32:bind-license-9.11.4-26.P2.el7_9.8.noarch                 6/10
    yandex.autogenerated_1:   Verifying  : 32:bind-libs-lite-9.11.4-26.P2.el7_9.8.x86_64               7/10
    yandex.autogenerated_1:   Verifying  : 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64                   8/10
    yandex.autogenerated_1:   Verifying  : 32:bind-libs-9.11.4-26.P2.el7_9.8.x86_64                    9/10
    yandex.autogenerated_1:   Verifying  : bridge-utils-1.5-9.el7.x86_64                              10/10
    yandex.autogenerated_1:
    yandex.autogenerated_1: Installed:
    yandex.autogenerated_1:   bind-utils.x86_64 32:9.11.4-26.P2.el7_9.8   bridge-utils.x86_64 0:1.5-9.el7
    yandex.autogenerated_1:   tcpdump.x86_64 14:4.9.2-4.el7_7.1           telnet.x86_64 1:0.17-66.el7
    yandex.autogenerated_1:
    yandex.autogenerated_1: Dependency Installed:
    yandex.autogenerated_1:   GeoIP.x86_64 0:1.5.0-14.el7
    yandex.autogenerated_1:   bind-libs.x86_64 32:9.11.4-26.P2.el7_9.8
    yandex.autogenerated_1:   bind-libs-lite.x86_64 32:9.11.4-26.P2.el7_9.8
    yandex.autogenerated_1:   bind-license.noarch 32:9.11.4-26.P2.el7_9.8
    yandex.autogenerated_1:   geoipupdate.x86_64 0:2.5.0-1.el7
    yandex.autogenerated_1:   libpcap.x86_64 14:1.5.3-12.el7
    yandex.autogenerated_1:
    yandex.autogenerated_1: Complete!
==> yandex.autogenerated_1: Stopping instance...
==> yandex.autogenerated_1: Deleting instance...
    yandex.autogenerated_1: Instance has been deleted!
==> yandex.autogenerated_1: Creating image: centos-7-base
==> yandex.autogenerated_1: Waiting for image to complete...
==> yandex.autogenerated_1: Success image create...
==> yandex.autogenerated_1: Destroying boot disk...
    yandex.autogenerated_1: Disk has been deleted!
Build 'yandex.autogenerated_1' finished after 2 minutes 7 seconds.

==> Wait completed after 2 minutes 7 seconds

==> Builds finished. The artifacts of successful builds are:
--> yandex.autogenerated_1: A disk image was created: centos-7-base (id: fd88bbgjvrb66jdheg9o) with family name centos
[gnoy@manjarokde-ws01 packer]$ yc vpc subnet delete --name my-subnet-a && yc vpc network delete --name net 
done (7s)
[gnoy@manjarokde-ws01 packer]$ yc iam service-account list
+----------------------+----------------+
|          ID          |      NAME      |
+----------------------+----------------+
| ajen1emrcbm11h42ui8i | netology-robot |
+----------------------+----------------+
[gnoy@manjarokde-ws01 packer]$ yc compute image list
+----------------------+---------------+--------+----------------------+--------+
|          ID          |     NAME      | FAMILY |     PRODUCT IDS      | STATUS |
+----------------------+---------------+--------+----------------------+--------+
| fd88bbgjvrb66jdheg9o | centos-7-base | centos | f2epin40q8nh7fqdv3sh | READY  |
+----------------------+---------------+--------+----------------------+--------+
[gnoy@manjarokde-ws01 packer]$ cd ../terraform/
[gnoy@manjarokde-ws01 terraform]$ yc iam key create --service-account-name netology-robot --output key.json
id: ajelc3hen9797ae1olpr
service_account_id: ajen1emrcbm11h42ui8i
created_at: "2022-02-15T11:24:09.654215869Z"
key_algorithm: RSA_2048
```
Запускаем deploy. Ждем...
```bash
[gnoy@manjarokde-ws01 terraform]$ terraform init -upgrade

Initializing the backend...

Initializing provider plugins...
- Finding latest version of yandex-cloud/yandex...
- Finding latest version of hashicorp/null...
- Finding latest version of hashicorp/local...
- Using previously-installed yandex-cloud/yandex v0.71.0
- Using previously-installed hashicorp/null v3.1.0
- Using previously-installed hashicorp/local v2.1.0

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
[gnoy@manjarokde-ws01 terraform]$ terraform apply -auto-approve

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # local_file.inventory will be created
  + resource "local_file" "inventory" {
      + content              = (known after apply)
      + directory_permission = "0777"
      + file_permission      = "0777"
      + filename             = "../ansible/inventory"
      + id                   = (known after apply)
    }

  # null_resource.docker will be created
  + resource "null_resource" "docker" {
      + id = (known after apply)
    }

  # null_resource.postgresql will be created
  + resource "null_resource" "postgresql" {
      + id = (known after apply)
    }

  # null_resource.start will be created
  + resource "null_resource" "start" {
      + id = (known after apply)
    }

  # null_resource.wait will be created
  + resource "null_resource" "wait" {
      + id = (known after apply)
    }

  # yandex_compute_instance.node01 will be created
  + resource "yandex_compute_instance" "node01" {
      + allow_stopping_for_update = true
      + created_at                = (known after apply)
      + folder_id                 = (known after apply)
      + fqdn                      = (known after apply)
      + hostname                  = "node01.netology.yc"
      + id                        = (known after apply)
      + metadata                  = {
          + "ssh-keys" = <<-EOT
                centos:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDAQrqhEDvkOhgrnOksf0Q/8iHIafkADpI+dabnPVGrjfEilNcIW+WH0wPDO53nDJqPgKFE9eZ+5CpMEkMX96SoR2fmdmx80qVKGW6/5z9IMtHnzpVkAVtSDguA/JV/bMP4vwov/DsvDN+/FwJ16EwX0t3Q5VgELYw/o6I1u981CCj+VdmjE7xdf8dNI+jvHN+ho59C1TXhUBevluAjB3MhRe+/chA524gYvf1L6APuCC05u+bV7YCKiQTugVE17oFDzTu76PQ/qRtvxZGk+p4+DWSluwNQL+6oM1zEjH6anqV7QEFpoKTPU5nAKh6mV3xSNUkiJfc6qnZHKLdAOm4qozEPvx6nYw9pypaVUwK35+L4hTPt/fAXjqcItsUK9v0vDdhwiYydgSItoxsDEvyevySwLTkJugtwuEwVShCSPcWN8fq5FwxEV/4fhJDrOimbE+hV11k3/5JfuHoN92z5ucJgF8QLIfPkBxSjRXXEqVfhqg6JTqTWBx6l4mxE2OWQ==
            EOT
        }
      + name                      = "node01"
      + network_acceleration_type = "standard"
      + platform_id               = "standard-v1"
      + service_account_id        = (known after apply)
      + status                    = (known after apply)
      + zone                      = "ru-central1-a"

      + boot_disk {
          + auto_delete = true
          + device_name = (known after apply)
          + disk_id     = (known after apply)
          + mode        = (known after apply)

          + initialize_params {
              + block_size  = (known after apply)
              + description = (known after apply)
              + image_id    = "fd88bbgjvrb66jdheg9o"
              + name        = "root-node01"
              + size        = 10
              + snapshot_id = (known after apply)
              + type        = "network-nvme"
            }
        }

      + network_interface {
          + index              = (known after apply)
          + ip_address         = "192.168.101.11"
          + ipv4               = true
          + ipv6               = (known after apply)
          + ipv6_address       = (known after apply)
          + mac_address        = (known after apply)
          + nat                = true
          + nat_ip_address     = (known after apply)
          + nat_ip_version     = (known after apply)
          + security_group_ids = (known after apply)
          + subnet_id          = (known after apply)
        }

      + placement_policy {
          + placement_group_id = (known after apply)
        }

      + resources {
          + core_fraction = 5
          + cores         = 2
          + memory        = 2
        }

      + scheduling_policy {
          + preemptible = (known after apply)
        }
    }

  # yandex_vpc_network.default will be created
  + resource "yandex_vpc_network" "default" {
      + created_at                = (known after apply)
      + default_security_group_id = (known after apply)
      + folder_id                 = (known after apply)
      + id                        = (known after apply)
      + labels                    = (known after apply)
      + name                      = "net"
      + subnet_ids                = (known after apply)
    }

  # yandex_vpc_subnet.default will be created
  + resource "yandex_vpc_subnet" "default" {
      + created_at     = (known after apply)
      + folder_id      = (known after apply)
      + id             = (known after apply)
      + labels         = (known after apply)
      + name           = "subnet"
      + network_id     = (known after apply)
      + v4_cidr_blocks = [
          + "192.168.101.0/24",
        ]
      + v6_cidr_blocks = (known after apply)
      + zone           = "ru-central1-a"
    }

Plan: 8 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + external_ip_address_node01 = (known after apply)
  + internal_ip_address_node01 = "192.168.101.11"
yandex_vpc_network.default: Creating...
yandex_vpc_network.default: Creation complete after 1s [id=enpeidahnlascijjl404]
yandex_vpc_subnet.default: Creating...
yandex_vpc_subnet.default: Creation complete after 0s [id=e9bmlnkh19onrt8gjku5]
yandex_compute_instance.node01: Creating...
yandex_compute_instance.node01: Still creating... [10s elapsed]
yandex_compute_instance.node01: Still creating... [20s elapsed]
yandex_compute_instance.node01: Still creating... [30s elapsed]
yandex_compute_instance.node01: Still creating... [40s elapsed]
yandex_compute_instance.node01: Creation complete after 42s [id=fhmsa1lr534ml82nqns0]
local_file.inventory: Creating...
local_file.inventory: Creation complete after 0s [id=c92a8c6237cc9b37d827d734b79ccd50e0ab970c]
null_resource.wait: Creating...
null_resource.wait: Provisioning with 'local-exec'...
null_resource.wait (local-exec): Executing: ["/bin/sh" "-c" "sleep 100"]
null_resource.wait: Still creating... [10s elapsed]
null_resource.wait: Still creating... [20s elapsed]
null_resource.wait: Still creating... [30s elapsed]
null_resource.wait: Still creating... [40s elapsed]
null_resource.wait: Still creating... [50s elapsed]
null_resource.wait: Still creating... [1m0s elapsed]
null_resource.wait: Still creating... [1m10s elapsed]
null_resource.wait: Still creating... [1m20s elapsed]
null_resource.wait: Still creating... [1m30s elapsed]
null_resource.wait: Still creating... [1m40s elapsed]
null_resource.wait: Creation complete after 1m40s [id=2159366637556780777]
null_resource.docker: Creating...
null_resource.docker: Provisioning with 'local-exec'...
null_resource.docker (local-exec): Executing: ["/bin/sh" "-c" "ANSIBLE_FORCE_COLOR=1 ansible-playbook -i ../ansible/inventory ../ansible/docker-deploy.yml"]

null_resource.docker (local-exec): PLAY [Install of Requrements Tools] ********************************************

null_resource.docker (local-exec): TASK [Gathering Facts] *********************************************************
null_resource.docker (local-exec): ok: [node01.netology.yc]

null_resource.docker (local-exec): TASK [install-tools : Installing tools] ****************************************
null_resource.docker (local-exec): ok: [node01.netology.yc] => (item=python)

null_resource.docker (local-exec): TASK [configure-hosts-file : Configure Hosts File] *****************************
null_resource.docker (local-exec): changed: [node01.netology.yc] => (item=node01.netology.yc)

null_resource.docker (local-exec): PLAY [Install Docker Engine] ***************************************************

null_resource.docker (local-exec): TASK [Gathering Facts] *********************************************************
null_resource.docker: Still creating... [10s elapsed]
null_resource.docker (local-exec): ok: [node01.netology.yc]

null_resource.docker (local-exec): TASK [docker-installation : Add docker repository] *****************************
null_resource.docker (local-exec): changed: [node01.netology.yc]

null_resource.docker (local-exec): TASK [docker-installation : Installing docker package] *************************
null_resource.docker: Still creating... [20s elapsed]
null_resource.docker: Still creating... [30s elapsed]
null_resource.docker: Still creating... [40s elapsed]
null_resource.docker: Still creating... [50s elapsed]
null_resource.docker: Still creating... [1m0s elapsed]
null_resource.docker: Still creating... [1m10s elapsed]
null_resource.docker: Still creating... [1m20s elapsed]
null_resource.docker: Still creating... [1m30s elapsed]
null_resource.docker: Still creating... [1m40s elapsed]
null_resource.docker (local-exec): changed: [node01.netology.yc] => (item=docker-ce)
null_resource.docker (local-exec): ok: [node01.netology.yc] => (item=docker-ce-cli)
null_resource.docker (local-exec): ok: [node01.netology.yc] => (item=containerd.io)

null_resource.docker (local-exec): TASK [docker-installation : Enable docker daemon] ******************************
null_resource.docker: Still creating... [1m50s elapsed]
null_resource.docker (local-exec): changed: [node01.netology.yc]

null_resource.docker (local-exec): TASK [docker-installation : Install docker-compose from official github repo] ***
null_resource.docker (local-exec): changed: [node01.netology.yc]

null_resource.docker (local-exec): PLAY RECAP *********************************************************************
null_resource.docker (local-exec): node01.netology.yc         : ok=8    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

null_resource.docker: Creation complete after 1m54s [id=5814736928899543857]
null_resource.postgresql: Creating...
null_resource.postgresql: Provisioning with 'local-exec'...
null_resource.postgresql (local-exec): Executing: ["/bin/sh" "-c" "ANSIBLE_FORCE_COLOR=1 ansible-playbook -i ../ansible/inventory ../ansible/sync-deploy.yml"]

null_resource.postgresql (local-exec): PLAY [nodes] *******************************************************************

null_resource.postgresql (local-exec): TASK [Gathering Facts] *********************************************************
null_resource.postgresql (local-exec): ok: [node01.netology.yc]

null_resource.postgresql (local-exec): TASK [Synchronization] *********************************************************
null_resource.postgresql (local-exec): changed: [node01.netology.yc]

null_resource.postgresql (local-exec): PLAY RECAP *********************************************************************
null_resource.postgresql (local-exec): node01.netology.yc         : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

null_resource.postgresql: Creation complete after 6s [id=4417829449239224817]
null_resource.start: Creating...
null_resource.start: Provisioning with 'local-exec'...
null_resource.start (local-exec): Executing: ["/bin/sh" "-c" "ANSIBLE_FORCE_COLOR=1 ansible-playbook -i ../ansible/inventory ../ansible/start-docker.yml"]

null_resource.start (local-exec): PLAY [nodes] *******************************************************************

null_resource.start (local-exec): TASK [Gathering Facts] *********************************************************
null_resource.start (local-exec): ok: [node01.netology.yc]

null_resource.start (local-exec): TASK [Run postgresql in docker] ************************************************
null_resource.start: Still creating... [10s elapsed]
null_resource.start: Still creating... [20s elapsed]
null_resource.start: Still creating... [30s elapsed]
null_resource.start: Still creating... [40s elapsed]
null_resource.start: Still creating... [50s elapsed]
null_resource.start (local-exec): changed: [node01.netology.yc]

null_resource.start (local-exec): PLAY RECAP *********************************************************************
null_resource.start (local-exec): node01.netology.yc         : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

null_resource.start: Creation complete after 58s [id=4748102748238921665]

Apply complete! Resources: 8 added, 0 changed, 0 destroyed.

Outputs:

external_ip_address_node01 = "84.201.130.143"
internal_ip_address_node01 = "192.168.101.11"

```
</details>

--  
docker-compose.yml
```docker
version: '3.3'

services:
  db:
    image: postgres:13
    restart: always
    container_name: postgres-13
    environment:
      - POSTGRES_PASSWORD=tmppassword
      - POSTGRES_USER=tmpuser
    volumes:
      - /opt/postgres/dbdata:/var/lib/postgresql/data
      - /opt/postgres/backup:/backup
    ports:
      - ${POSTGRES_PORT:-5432}:5432
```
<details>
  <summary>Console</summary>


Подключаемся к инстансу, контейнеру
```bash
[gnoy@manjarokde-ws01 terraform]$ ssh centos@84.201.130.143
[centos@node01 ~]$ sudo docker ps
CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS         PORTS                                       NAMES
1fa4c37d6756   postgres:13   "docker-entrypoint.s…"   3 minutes ago   Up 2 minutes   0.0.0.0:5432->5432/tcp, :::5432->5432/tcp   postgres-13
[centos@node01 ~]$ sudo docker exec -it postgres-13 bash
root@1fa4c37d6756:/# psql -U tmpuser
psql (13.6 (Debian 13.6-1.pgdg110+1))
Type "help" for help.

tmpuser=#
```

</details>

**Найдите и приведите** управляющие команды для:
- вывода списка БД `tmpuser=#  \l`
- подключения к БД `tmpuser=# \c {NAME_DB}`
- вывода списка таблиц `tmpuser=# \dt`
- вывода описания содержимого таблиц `tmpuser=# \d NAME`
- выхода из psql `tmpuser=# \q`

## Задача 2

Используя `psql` создайте БД `test_database`.

Изучите [бэкап БД](https://github.com/netology-code/virt-homeworks/tree/master/06-db-04-postgresql/test_data).

Восстановите бэкап БД в `test_database`.

Перейдите в управляющую консоль `psql` внутри контейнера.

Подключитесь к восстановленной БД и проведите операцию ANALYZE для сбора статистики по таблице.

Используя таблицу [pg_stats](https://postgrespro.ru/docs/postgresql/12/view-pg-stats), найдите столбец таблицы `orders` 
с наибольшим средним значением размера элементов в байтах.

**Приведите в ответе** команду, которую вы использовали для вычисления и полученный результат.  

Ответ:  

<details>
  <summary>Console</summary>

Создаем БД, восстанавливаем ее из бекапа, проводим операцию ANALYZE
```bash
tmpuser=# CREATE DATABASE test_database;
CREATE DATABASE
tmpuser=# \c test_database
You are now connected to database "test_database" as user "tmpuser".
test_database=# 
```
```bash
root@1fa4c37d6756:/# psql -U tmpuser -d test_database < /backup/test_dump.sql 
SET
SET
SET
SET
SET
 set_config 
------------
 
(1 row)

SET
SET
SET
SET
SET
SET
CREATE TABLE
ERROR:  role "postgres" does not exist
CREATE SEQUENCE
ERROR:  role "postgres" does not exist
ALTER SEQUENCE
ALTER TABLE
COPY 8
 setval 
--------
      8
(1 row)

ALTER TABLE
```
```bash
test_database=# ANALYZE VERBOSE public.orders;
INFO:  analyzing "public.orders"
INFO:  "orders": scanned 1 of 1 pages, containing 8 live rows and 0 dead rows; 8 rows in sample, 8 estimated total rows
ANALYZE
```
</details>

```bash
test_database=# select avg_width, attname FROM pg_stats WHERE tablename = 'orders' ORDER by attname DESC LIMIT 1;
 avg_width | attname 
-----------+---------
        16 | title
(1 row)
```

## Задача 3

Архитектор и администратор БД выяснили, что ваша таблица orders разрослась до невиданных размеров и
поиск по ней занимает долгое время. Вам, как успешному выпускнику курсов DevOps в нетологии предложили
провести разбиение таблицы на 2 (шардировать на orders_1 - price>499 и orders_2 - price<=499).

Предложите SQL-транзакцию для проведения данной операции.

Можно ли было изначально исключить "ручное" разбиение при проектировании таблицы orders?  

Ответ:  
Создаю новую таблицу
```sql
test_database=# CREATE table new_orders (
      id integer NOT NULL,
      title character varying(80) NOT NULL,
      price integer DEFAULT 0
    ) partition by range ( price);
```
Создаю партицию orders_1 со значением price > 499 (int=2^31-1 = 2147483647)
```sql
test_database=# create table orders_1 partition of new_orders for values from (500) to (2147483647);
CREATE TABLE
```
Создаю партицию orders_2 со значением price <=499
```sql
test_database=# create table orders_2 partition of new_orders for values from (0) to (500);
CREATE TABLE
```
Проверим new_orders
```sql
test_database=# \d+ new_orders
                                  Partitioned table "public.new_orders"
 Column |         Type          | Collation | Nullable | Default | Storage  | Stats target | Description 
--------+-----------------------+-----------+----------+---------+----------+--------------+-------------
 id     | integer               |           | not null |         | plain    |              | 
 title  | character varying(80) |           | not null |         | extended |              | 
 price  | integer               |           |          | 0       | plain    |              | 
Partition key: RANGE (price)
Partitions: orders_1 FOR VALUES FROM (500) TO (2147483647),
            orders_2 FOR VALUES FROM (0) TO (500)
```
Наполняем new_orders, а следовательно и orders_1 и order_2
```sql
test_database=# INSERT into new_orders (id, price, title) select id, price, title from orders;
INSERT 0 8
```
Проверяем результат
```sql
test_database=# SELECT * FROM new_orders;
 id |        title         | price 
----+----------------------+-------
  1 | War and peace        |   100
  3 | Adventure psql time  |   300
  4 | Server gravity falls |   300
  5 | Log gossips          |   123
  7 | Me and my bash-pet   |   499
  2 | My little database   |   500
  6 | WAL never lies       |   900
  8 | Dbiezdmin            |   501
(8 rows)

test_database=# SELECT * FROM orders_1;
 id |       title        | price 
----+--------------------+-------
  2 | My little database |   500
  6 | WAL never lies     |   900
  8 | Dbiezdmin          |   501
(3 rows)

test_database=# SELECT * FROM orders_2;
 id |        title         | price 
----+----------------------+-------
  1 | War and peace        |   100
  3 | Adventure psql time  |   300
  4 | Server gravity falls |   300
  5 | Log gossips          |   123
  7 | Me and my bash-pet   |   499
(5 rows)
```

При проектировании таблицы orders можно изначально исключить "ручное" разбиение если задать правила распределения по таблицам.



## Задача 4

Используя утилиту `pg_dump` создайте бекап БД `test_database`.

Как бы вы доработали бэкап-файл, чтобы добавить уникальность значения столбца `title` для таблиц `test_database`?  

Ответ:  
Бекапим
```bash
root@75dc9dcb5934:/# pg_dump -U tmpuser -d test_database > /backup/test_database_postgres_13.dump
root@75dc9dcb5934:/# ls -lh /backup/
total 8.0K
-rw-r--r--. 1 root root 3.5K Feb 26 03:44 test_database_postgres_13.dump
-rw-r--r--. 1 root root 2.1K Feb 26 03:35 test_dump.sql
```
Добавим в конец бекапа (после строчки создания первичного ключа) еще строчку проверки на уникатьность столбца title:
```sql
ALTER TABLE ONLY public.orders ADD CONSTRAINT title_unique UNIQUE (title);
```