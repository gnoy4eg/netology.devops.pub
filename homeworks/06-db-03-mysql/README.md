# Домашнее задание к занятию "6.3. MySQL"

## Введение

Перед выполнением задания вы можете ознакомиться с 
[дополнительными материалами](https://github.com/netology-code/virt-homeworks/tree/master/additional/README.md).

## Задача 1

Используя docker поднимите инстанс MySQL (версию 8). Данные БД сохраните в volume.

Изучите [бэкап БД](https://github.com/netology-code/virt-homeworks/tree/master/06-db-03-mysql/test_data) и 
восстановитесь из него.

Перейдите в управляющую консоль `mysql` внутри контейнера.

Используя команду `\h` получите список управляющих команд.

Найдите команду для выдачи статуса БД и **приведите в ответе** из ее вывода версию сервера БД.

Подключитесь к восстановленной БД и получите список таблиц из этой БД.

**Приведите в ответе** количество записей с `price` > 300.

В следующих заданиях мы будем продолжать работу с данным контейнером.  

Ответ:  
К решению задачи подойдем с применением подхода IaC.
Разверну инстанс на YandexCloud. ДЗ буду делать в нем.
Комментарии не относящиеся к решению задачи буду прятать под спойлер.

<details>
  <summary>Console</summary>

Создаем сеть для создания образа ВМ в YC.
```bash
yc vpc network create --name net --labels my-label=netology --description "my build network via yc" && yc vpc subnet create --name my-subnet-a --zone ru-central1-a --range 10.1.2.0/24 --network-name net --description "my build subnet via yc"
```
Билдим образ системы:
```bash
[gnoy@manjarokde-ws01 packer]$ packer validate centos-7-base.json.pkr.hcl 
The configuration is valid.
[gnoy@manjarokde-ws01 packer]$ packer build centos-7-base.json.pkr.hcl 
yandex.autogenerated_1: output will be in this color.

==> yandex.autogenerated_1: Creating temporary RSA SSH key for instance...
==> yandex.autogenerated_1: Using as source image: fd82n2d2h9fet9648lej (name: "centos-7-v20220214", family: "centos-7")
==> yandex.autogenerated_1: Use provided subnet id e9bo4l91g81obfpmhgpj
==> yandex.autogenerated_1: Creating disk...
==> yandex.autogenerated_1: Creating instance...
==> yandex.autogenerated_1: Waiting for instance with id fhm2mu4got4m5hfp3fvq to become active...
    yandex.autogenerated_1: Detected instance IP: 84.201.129.58
==> yandex.autogenerated_1: Using SSH communicator to connect: 84.201.129.58
==> yandex.autogenerated_1: Waiting for SSH to become available...
==> yandex.autogenerated_1: Connected to SSH!
==> yandex.autogenerated_1: Provisioning with shell script: /tmp/packer-shell2895023227
    yandex.autogenerated_1: Loaded plugins: fastestmirror
    yandex.autogenerated_1: Loading mirror speeds from cached hostfile
    yandex.autogenerated_1:  * base: centos-mirror.rbc.ru
    yandex.autogenerated_1:  * extras: mirror.reconn.ru
    yandex.autogenerated_1:  * updates: mirror.reconn.ru
    yandex.autogenerated_1: No packages marked for update
    yandex.autogenerated_1: Loaded plugins: fastestmirror
    yandex.autogenerated_1: Loading mirror speeds from cached hostfile
    yandex.autogenerated_1:  * base: centos-mirror.rbc.ru
    yandex.autogenerated_1:  * extras: mirror.reconn.ru
    yandex.autogenerated_1:  * updates: mirror.reconn.ru
    yandex.autogenerated_1: Package curl-7.29.0-59.el7_9.1.x86_64 already installed and latest version
    yandex.autogenerated_1: Package net-tools-2.0-0.25.20131004git.el7.x86_64 already installed and latest version
    yandex.autogenerated_1: Package rsync-3.1.2-10.el7.x86_64 already installed and latest version
    yandex.autogenerated_1: Package openssh-server-7.4p1-22.el7_9.x86_64 already installed and latest version
    yandex.autogenerated_1: Resolving Dependencies
    yandex.autogenerated_1: --> Running transaction check
    yandex.autogenerated_1: ---> Package bind-utils.x86_64 32:9.11.4-26.P2.el7_9.8 will be installed
    yandex.autogenerated_1: --> Processing Dependency: bind-libs-lite(x86-64) = 32:9.11.4-26.P2.el7_9.8 for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: bind-libs(x86-64) = 32:9.11.4-26.P2.el7_9.8 for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: liblwres.so.160()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libisccfg.so.160()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libisc.so.169()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libirs.so.160()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libdns.so.1102()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libbind9.so.160()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libGeoIP.so.1()(64bit) for package: 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: ---> Package bridge-utils.x86_64 0:1.5-9.el7 will be installed
    yandex.autogenerated_1: ---> Package tcpdump.x86_64 14:4.9.2-4.el7_7.1 will be installed
    yandex.autogenerated_1: --> Processing Dependency: libpcap >= 14:1.5.3-10 for package: 14:tcpdump-4.9.2-4.el7_7.1.x86_64
    yandex.autogenerated_1: --> Processing Dependency: libpcap.so.1()(64bit) for package: 14:tcpdump-4.9.2-4.el7_7.1.x86_64
    yandex.autogenerated_1: ---> Package telnet.x86_64 1:0.17-66.el7 will be installed
    yandex.autogenerated_1: --> Running transaction check
    yandex.autogenerated_1: ---> Package GeoIP.x86_64 0:1.5.0-14.el7 will be installed
    yandex.autogenerated_1: --> Processing Dependency: geoipupdate for package: GeoIP-1.5.0-14.el7.x86_64
    yandex.autogenerated_1: ---> Package bind-libs.x86_64 32:9.11.4-26.P2.el7_9.8 will be installed
    yandex.autogenerated_1: --> Processing Dependency: bind-license = 32:9.11.4-26.P2.el7_9.8 for package: 32:bind-libs-9.11.4-26.P2.el7_9.8.x86_64
    yandex.autogenerated_1: ---> Package bind-libs-lite.x86_64 32:9.11.4-26.P2.el7_9.8 will be installed
    yandex.autogenerated_1: ---> Package libpcap.x86_64 14:1.5.3-12.el7 will be installed
    yandex.autogenerated_1: --> Running transaction check
    yandex.autogenerated_1: ---> Package bind-license.noarch 32:9.11.4-26.P2.el7_9.8 will be installed
    yandex.autogenerated_1: ---> Package geoipupdate.x86_64 0:2.5.0-1.el7 will be installed
    yandex.autogenerated_1: --> Finished Dependency Resolution
    yandex.autogenerated_1:
    yandex.autogenerated_1: Dependencies Resolved
    yandex.autogenerated_1:
    yandex.autogenerated_1: ================================================================================
    yandex.autogenerated_1:  Package            Arch       Version                        Repository   Size
    yandex.autogenerated_1: ================================================================================
    yandex.autogenerated_1: Installing:
    yandex.autogenerated_1:  bind-utils         x86_64     32:9.11.4-26.P2.el7_9.8        updates     261 k
    yandex.autogenerated_1:  bridge-utils       x86_64     1.5-9.el7                      base         32 k
    yandex.autogenerated_1:  tcpdump            x86_64     14:4.9.2-4.el7_7.1             base        422 k
    yandex.autogenerated_1:  telnet             x86_64     1:0.17-66.el7                  updates      64 k
    yandex.autogenerated_1: Installing for dependencies:
    yandex.autogenerated_1:  GeoIP              x86_64     1.5.0-14.el7                   base        1.5 M
    yandex.autogenerated_1:  bind-libs          x86_64     32:9.11.4-26.P2.el7_9.8        updates     157 k
    yandex.autogenerated_1:  bind-libs-lite     x86_64     32:9.11.4-26.P2.el7_9.8        updates     1.1 M
    yandex.autogenerated_1:  bind-license       noarch     32:9.11.4-26.P2.el7_9.8        updates      91 k
    yandex.autogenerated_1:  geoipupdate        x86_64     2.5.0-1.el7                    base         35 k
    yandex.autogenerated_1:  libpcap            x86_64     14:1.5.3-12.el7                base        139 k
    yandex.autogenerated_1:
    yandex.autogenerated_1: Transaction Summary
    yandex.autogenerated_1: ================================================================================
    yandex.autogenerated_1: Install  4 Packages (+6 Dependent packages)
    yandex.autogenerated_1:
    yandex.autogenerated_1: Total download size: 3.8 M
    yandex.autogenerated_1: Installed size: 9.0 M
    yandex.autogenerated_1: Downloading packages:
    yandex.autogenerated_1: --------------------------------------------------------------------------------
    yandex.autogenerated_1: Total                                               13 MB/s | 3.8 MB  00:00
    yandex.autogenerated_1: Running transaction check
    yandex.autogenerated_1: Running transaction test
    yandex.autogenerated_1: Transaction test succeeded
    yandex.autogenerated_1: Running transaction
    yandex.autogenerated_1:   Installing : 32:bind-license-9.11.4-26.P2.el7_9.8.noarch                 1/10
    yandex.autogenerated_1:   Installing : geoipupdate-2.5.0-1.el7.x86_64                              2/10
    yandex.autogenerated_1:   Installing : GeoIP-1.5.0-14.el7.x86_64                                   3/10
    yandex.autogenerated_1:   Installing : 32:bind-libs-lite-9.11.4-26.P2.el7_9.8.x86_64               4/10
    yandex.autogenerated_1:   Installing : 32:bind-libs-9.11.4-26.P2.el7_9.8.x86_64                    5/10
    yandex.autogenerated_1:   Installing : 14:libpcap-1.5.3-12.el7.x86_64                              6/10
    yandex.autogenerated_1: pam_tally2: Error opening /var/log/tallylog for update: Permission denied
    yandex.autogenerated_1: pam_tally2: Authentication error
    yandex.autogenerated_1: useradd: failed to reset the tallylog entry of user "tcpdump"
    yandex.autogenerated_1:   Installing : 14:tcpdump-4.9.2-4.el7_7.1.x86_64                           7/10
    yandex.autogenerated_1:   Installing : 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64                   8/10
    yandex.autogenerated_1:   Installing : bridge-utils-1.5-9.el7.x86_64                               9/10
    yandex.autogenerated_1:   Installing : 1:telnet-0.17-66.el7.x86_64                                10/10
    yandex.autogenerated_1:   Verifying  : GeoIP-1.5.0-14.el7.x86_64                                   1/10
    yandex.autogenerated_1:   Verifying  : 1:telnet-0.17-66.el7.x86_64                                 2/10
    yandex.autogenerated_1:   Verifying  : 14:libpcap-1.5.3-12.el7.x86_64                              3/10
    yandex.autogenerated_1:   Verifying  : geoipupdate-2.5.0-1.el7.x86_64                              4/10
    yandex.autogenerated_1:   Verifying  : 14:tcpdump-4.9.2-4.el7_7.1.x86_64                           5/10
    yandex.autogenerated_1:   Verifying  : 32:bind-license-9.11.4-26.P2.el7_9.8.noarch                 6/10
    yandex.autogenerated_1:   Verifying  : 32:bind-libs-lite-9.11.4-26.P2.el7_9.8.x86_64               7/10
    yandex.autogenerated_1:   Verifying  : 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64                   8/10
    yandex.autogenerated_1:   Verifying  : 32:bind-libs-9.11.4-26.P2.el7_9.8.x86_64                    9/10
    yandex.autogenerated_1:   Verifying  : bridge-utils-1.5-9.el7.x86_64                              10/10
    yandex.autogenerated_1:
    yandex.autogenerated_1: Installed:
    yandex.autogenerated_1:   bind-utils.x86_64 32:9.11.4-26.P2.el7_9.8   bridge-utils.x86_64 0:1.5-9.el7
    yandex.autogenerated_1:   tcpdump.x86_64 14:4.9.2-4.el7_7.1           telnet.x86_64 1:0.17-66.el7
    yandex.autogenerated_1:
    yandex.autogenerated_1: Dependency Installed:
    yandex.autogenerated_1:   GeoIP.x86_64 0:1.5.0-14.el7
    yandex.autogenerated_1:   bind-libs.x86_64 32:9.11.4-26.P2.el7_9.8
    yandex.autogenerated_1:   bind-libs-lite.x86_64 32:9.11.4-26.P2.el7_9.8
    yandex.autogenerated_1:   bind-license.noarch 32:9.11.4-26.P2.el7_9.8
    yandex.autogenerated_1:   geoipupdate.x86_64 0:2.5.0-1.el7
    yandex.autogenerated_1:   libpcap.x86_64 14:1.5.3-12.el7
    yandex.autogenerated_1:
    yandex.autogenerated_1: Complete!
==> yandex.autogenerated_1: Stopping instance...
==> yandex.autogenerated_1: Deleting instance...
    yandex.autogenerated_1: Instance has been deleted!
==> yandex.autogenerated_1: Creating image: centos-7-base
==> yandex.autogenerated_1: Waiting for image to complete...
==> yandex.autogenerated_1: Success image create...
==> yandex.autogenerated_1: Destroying boot disk...
    yandex.autogenerated_1: Disk has been deleted!
Build 'yandex.autogenerated_1' finished after 2 minutes 2 seconds.

==> Wait completed after 2 minutes 2 seconds

==> Builds finished. The artifacts of successful builds are:
--> yandex.autogenerated_1: A disk image was created: centos-7-base (id: fd85r12arfq9sshb8b70) with family name centos
```
Удаляем временную подсеть
```bash
[gnoy@manjarokde-ws01 packer]$ yc vpc subnet delete --name my-subnet-a && yc vpc network delete --name net 
done (1s)
```
Образ готов, на его базе будем делать ДЗ
```bash
[gnoy@manjarokde-ws01 packer]$ yc compute image list
+----------------------+---------------+--------+----------------------+--------+
|          ID          |     NAME      | FAMILY |     PRODUCT IDS      | STATUS |
+----------------------+---------------+--------+----------------------+--------+
| fd85r12arfq9sshb8b70 | centos-7-base | centos | f2epin40q8nh7fqdv3sh | READY  |
+----------------------+---------------+--------+----------------------+--------+
```
Разворачиваем инстанс
```bash
[gnoy@manjarokde-ws01 terraform]$ terraform init

Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/null...
- Finding latest version of hashicorp/local...
- Finding latest version of yandex-cloud/yandex...
- Installing hashicorp/null v3.1.0...
- Installed hashicorp/null v3.1.0 (signed by HashiCorp)
- Installing hashicorp/local v2.1.0...
- Installed hashicorp/local v2.1.0 (signed by HashiCorp)
- Installing yandex-cloud/yandex v0.71.0...
- Installed yandex-cloud/yandex v0.71.0 (self-signed, key ID E40F590B50BB8E40)

Partner and community providers are signed by their developers.
If you'd like to know more about provider signing, you can read about it here:
https://www.terraform.io/docs/cli/plugins/signing.html

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.

[gnoy@manjarokde-ws01 terraform]$ terraform apply -auto-approve

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # local_file.inventory will be created
  + resource "local_file" "inventory" {
      + content              = (known after apply)
      + directory_permission = "0777"
      + file_permission      = "0777"
      + filename             = "../ansible/inventory"
      + id                   = (known after apply)
    }

  # null_resource.docker will be created
  + resource "null_resource" "docker" {
      + id = (known after apply)
    }

  # null_resource.mysql will be created
  + resource "null_resource" "mysql" {
      + id = (known after apply)
    }

  # null_resource.start will be created
  + resource "null_resource" "start" {
      + id = (known after apply)
    }

  # null_resource.wait will be created
  + resource "null_resource" "wait" {
      + id = (known after apply)
    }

  # yandex_compute_instance.node01 will be created
  + resource "yandex_compute_instance" "node01" {
      + allow_stopping_for_update = true
      + created_at                = (known after apply)
      + folder_id                 = (known after apply)
      + fqdn                      = (known after apply)
      + hostname                  = "node01.netology.yc"
      + id                        = (known after apply)
      + metadata                  = {
          + "ssh-keys" = <<-EOT
                centos:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDAQrqhEDvkOhgrnOksf0Q/8iHIafkADpI+dabnPVGrjfEilNcIW+WH0wPDO53nDJqPgKFE9eZ+5CpMEkMX96SoR2fmdmx80qVKGW6/5z9IMtHnzpVkAVtSDguA/JV/bMP4vwov/DsvDN+/FwJ16EwX0t3Q5VgELYw/o6I1u981CCj+VdmjE7xdf8dNI+jvHN+ho59C1TXhUBevluAjB3MhRe+j3pN6slzXgS2Dun99GvNjPVD14V6piA2V7Cb88haJ7SfzvOV7CrZfsjFZ0Q4eEKy9F3aNUiL7q0DqrFpoXCfpqM1I9D7Kt1b02UjOemAmYrmLCo/chA524gYvf1L6APuCC05u+bV7YCKiQTugVE17oFDzTu76PQ/qRtvxZGk+p4+DWSluwNQL+6oM1zEjH6anqV7QEFpoKTPU5nAKh6mV3xSNUkiJfc6qnZHKLdAOm4qozEPvx6nYw9pypaVUwK35+L4hTPt/yILerk5FT1fFuMQnOK9S4aOyisLHN2a3FHDenWOUsQszLSzrJxNNvhDqTo/fAXjqcItsUK9v0vDdhwiYydgSItoxsDEvyevySwLTkJugtwuEwVShCSPcWN8fq5FwxEV/4fhJDrOimbE+hV11k3/5JfuHoN92z5ucJgF8QLIfPkBxSjRXXEqVfhqg6JTqTWBx6l4mxE2OWQ==
            EOT
        }
      + name                      = "node01"
      + network_acceleration_type = "standard"
      + platform_id               = "standard-v1"
      + service_account_id        = (known after apply)
      + status                    = (known after apply)
      + zone                      = "ru-central1-a"

      + boot_disk {
          + auto_delete = true
          + device_name = (known after apply)
          + disk_id     = (known after apply)
          + mode        = (known after apply)

          + initialize_params {
              + block_size  = (known after apply)
              + description = (known after apply)
              + image_id    = "fd85r12arfq9sshb8b70"
              + name        = "root-node01"
              + size        = 10
              + snapshot_id = (known after apply)
              + type        = "network-hdd"
            }
        }

      + network_interface {
          + index              = (known after apply)
          + ip_address         = "192.168.101.11"
          + ipv4               = true
          + ipv6               = (known after apply)
          + ipv6_address       = (known after apply)
          + mac_address        = (known after apply)
          + nat                = true
          + nat_ip_address     = (known after apply)
          + nat_ip_version     = (known after apply)
          + security_group_ids = (known after apply)
          + subnet_id          = (known after apply)
        }

      + placement_policy {
          + placement_group_id = (known after apply)
        }

      + resources {
          + core_fraction = 5
          + cores         = 2
          + memory        = 2
        }

      + scheduling_policy {
          + preemptible = (known after apply)
        }
    }

  # yandex_vpc_network.default will be created
  + resource "yandex_vpc_network" "default" {
      + created_at                = (known after apply)
      + default_security_group_id = (known after apply)
      + folder_id                 = (known after apply)
      + id                        = (known after apply)
      + labels                    = (known after apply)
      + name                      = "net"
      + subnet_ids                = (known after apply)
    }

  # yandex_vpc_subnet.default will be created
  + resource "yandex_vpc_subnet" "default" {
      + created_at     = (known after apply)
      + folder_id      = (known after apply)
      + id             = (known after apply)
      + labels         = (known after apply)
      + name           = "subnet"
      + network_id     = (known after apply)
      + v4_cidr_blocks = [
          + "192.168.101.0/24",
        ]
      + v6_cidr_blocks = (known after apply)
      + zone           = "ru-central1-a"
    }

Plan: 8 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + external_ip_address_node01 = (known after apply)
  + internal_ip_address_node01 = "192.168.101.11"
yandex_vpc_network.default: Creating...
yandex_vpc_network.default: Creation complete after 2s [id=enpfklu4f43lkeo4bo52]
yandex_vpc_subnet.default: Creating...
yandex_vpc_subnet.default: Creation complete after 0s [id=e9bas8lbqm0t3g69govo]
yandex_compute_instance.node01: Creating...
yandex_compute_instance.node01: Still creating... [10s elapsed]
yandex_compute_instance.node01: Still creating... [20s elapsed]
yandex_compute_instance.node01: Still creating... [30s elapsed]
yandex_compute_instance.node01: Still creating... [40s elapsed]
yandex_compute_instance.node01: Creation complete after 44s [id=fhmlh61p0e6fp5t8lr6k]
local_file.inventory: Creating...
local_file.inventory: Creation complete after 0s [id=0ac5144bf41c3fa9a6f6de2e7e17fcb80185e8ea]
null_resource.wait: Creating...
null_resource.wait: Provisioning with 'local-exec'...
null_resource.wait (local-exec): Executing: ["/bin/sh" "-c" "sleep 100"]
null_resource.wait: Still creating... [10s elapsed]
null_resource.wait: Still creating... [20s elapsed]
null_resource.wait: Still creating... [30s elapsed]
null_resource.wait: Still creating... [40s elapsed]
null_resource.wait: Still creating... [50s elapsed]
null_resource.wait: Still creating... [1m0s elapsed]
null_resource.wait: Still creating... [1m10s elapsed]
null_resource.wait: Still creating... [1m20s elapsed]
null_resource.wait: Still creating... [1m30s elapsed]
null_resource.wait: Creation complete after 1m40s [id=5659772405166511706]
null_resource.docker: Creating...
null_resource.docker: Provisioning with 'local-exec'...
null_resource.docker (local-exec): Executing: ["/bin/sh" "-c" "ANSIBLE_FORCE_COLOR=1 ansible-playbook -i ../ansible/inventory ../ansible/docker-deploy.yml"]

null_resource.docker (local-exec): PLAY [Install of Requrements Tools] ********************************************

null_resource.docker (local-exec): TASK [Gathering Facts] *********************************************************
null_resource.docker (local-exec): ok: [node01.netology.yc]

null_resource.docker (local-exec): TASK [install-tools : Installing tools] ****************************************
null_resource.docker (local-exec): ok: [node01.netology.yc] => (item=python)

null_resource.docker (local-exec): TASK [configure-hosts-file : Configure Hosts File] *****************************
null_resource.docker: Still creating... [10s elapsed]
null_resource.docker (local-exec): changed: [node01.netology.yc] => (item=node01.netology.yc)

null_resource.docker (local-exec): PLAY [Install Docker Engine] ***************************************************

null_resource.docker (local-exec): TASK [Gathering Facts] *********************************************************
null_resource.docker (local-exec): ok: [node01.netology.yc]

null_resource.docker (local-exec): TASK [mysql-installation : Add docker repository] ******************************
null_resource.docker (local-exec): changed: [node01.netology.yc]

null_resource.docker (local-exec): TASK [mysql-installation : Installing docker package] **************************
null_resource.docker: Still creating... [20s elapsed]
null_resource.docker: Still creating... [30s elapsed]
null_resource.docker: Still creating... [40s elapsed]
null_resource.docker: Still creating... [50s elapsed]
null_resource.docker: Still creating... [1m0s elapsed]
null_resource.docker: Still creating... [1m10s elapsed]
null_resource.docker: Still creating... [1m20s elapsed]
null_resource.docker: Still creating... [1m30s elapsed]
null_resource.docker: Still creating... [1m40s elapsed]
null_resource.docker (local-exec): changed: [node01.netology.yc] => (item=docker-ce)
null_resource.docker (local-exec): ok: [node01.netology.yc] => (item=docker-ce-cli)
null_resource.docker (local-exec): ok: [node01.netology.yc] => (item=containerd.io)

null_resource.docker (local-exec): TASK [mysql-installation : Enable docker daemon] *******************************
null_resource.docker: Still creating... [1m50s elapsed]
null_resource.docker (local-exec): changed: [node01.netology.yc]

null_resource.docker (local-exec): TASK [mysql-installation : Install docker-compose from official github repo] ***
null_resource.docker (local-exec): changed: [node01.netology.yc]

null_resource.docker (local-exec): PLAY RECAP *********************************************************************
null_resource.docker (local-exec): node01.netology.yc         : ok=8    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

null_resource.docker: Creation complete after 1m56s [id=6542692138930024492]
null_resource.mysql: Creating...
null_resource.mysql: Provisioning with 'local-exec'...
null_resource.mysql (local-exec): Executing: ["/bin/sh" "-c" "ANSIBLE_FORCE_COLOR=1 ansible-playbook -i ../ansible/inventory ../ansible/sync-deploy.yml"]

null_resource.mysql (local-exec): PLAY [nodes] *******************************************************************

null_resource.mysql (local-exec): TASK [Gathering Facts] *********************************************************
null_resource.mysql (local-exec): ok: [node01.netology.yc]

null_resource.mysql (local-exec): TASK [Copy docker-compose.yml] *************************************************
null_resource.mysql (local-exec): changed: [node01.netology.yc]

null_resource.mysql (local-exec): TASK [Copy test_dump.sql] ******************************************************
null_resource.mysql (local-exec): changed: [node01.netology.yc]

null_resource.mysql (local-exec): PLAY RECAP *********************************************************************
null_resource.mysql (local-exec): node01.netology.yc         : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

null_resource.mysql: Creation complete after 10s [id=2991353908707711055]
null_resource.start: Creating...
null_resource.start: Provisioning with 'local-exec'...
null_resource.start (local-exec): Executing: ["/bin/sh" "-c" "ANSIBLE_FORCE_COLOR=1 ansible-playbook -i ../ansible/inventory ../ansible/start-docker.yml"]

null_resource.start (local-exec): PLAY [nodes] *******************************************************************

null_resource.start (local-exec): TASK [Gathering Facts] *********************************************************
null_resource.start (local-exec): ok: [node01.netology.yc]

null_resource.start (local-exec): TASK [Run mysql in docker] *****************************************************
null_resource.start: Still creating... [10s elapsed]
null_resource.start: Still creating... [20s elapsed]
null_resource.start: Still creating... [30s elapsed]
null_resource.start (local-exec): changed: [node01.netology.yc]

null_resource.start (local-exec): PLAY RECAP *********************************************************************
null_resource.start (local-exec): node01.netology.yc         : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

null_resource.start: Creation complete after 30s [id=6626706378456408774]

Apply complete! Resources: 8 added, 0 changed, 0 destroyed.

Outputs:

external_ip_address_node01 = "130.193.38.84"
internal_ip_address_node01 = "192.168.101.11"
```

</details>


docker-compose.yml
```docker
version: '3.3'

services:
  db:
    image: mysql:8
    restart: always
    container_name: mysql-8
    environment:
      MYSQL_DATABASE: 'test_db'
      MYSQL_USER: 'rootuser'
      MYSQL_PASSWORD: 'password'
      MYSQL_ROOT_PASSWORD: 'rootpassword'
    volumes:
      - /opt/mysql/dbdata:/var/lib/mysql
      - /opt/mysql/backup:/backup
    ports:
      - ${POSTGRES_PORT:-3306}:3306
```
Подключаемся к инстансу, контейнеру и восстанавливаем базу mysql из бекапа
```bash
[gnoy@manjarokde-ws01 terraform]$ ssh centos@130.193.51.210
[centos@node01 ~]$ sudo docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                                                  NAMES
99b889586406   mysql:8   "docker-entrypoint.s…"   5 seconds ago   Up 3 seconds   0.0.0.0:3306->3306/tcp, :::3306->3306/tcp, 33060/tcp   mysql-8
[centos@node01 ~]$ sudo docker exec -it mysql-8 bash
root@99b889586406:/# mysql -u rootuser -p test_db < /backup/test_dump.sql 
Enter password: 
root@99b889586406:/# 
```
Подключаемся к базе, выводим статус БД. Версия `8.0.28`
```sql
root@7fe5f2a0504f:/# mysql -u rootuser -p test_db
Enter password: 
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 12
Server version: 8.0.28 MySQL Community Server - GPL

Copyright (c) 2000, 2022, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> status
--------------
mysql  Ver 8.0.28 for Linux on x86_64 (MySQL Community Server - GPL)

Connection id:          12
Current database:       test_db
Current user:           rootuser@localhost
SSL:                    Not in use
Current pager:          stdout
Using outfile:          ''
Using delimiter:        ;
Server version:         8.0.28 MySQL Community Server - GPL
Protocol version:       10
Connection:             Localhost via UNIX socket
Server characterset:    utf8mb4
Db     characterset:    utf8mb4
Client characterset:    latin1
Conn.  characterset:    latin1
UNIX socket:            /var/run/mysqld/mysqld.sock
Binary data as:         Hexadecimal
Uptime:                 3 min 12 sec

Threads: 4  Questions: 68  Slow queries: 0  Opens: 192  Flush tables: 3  Open tables: 110  Queries per second avg: 0.354
--------------
```
Список таблиц
```sql
mysql> SHOW TABLES;
+-------------------+
| Tables_in_test_db |
+-------------------+
| orders            |
+-------------------+
1 row in set (0.00 sec)
```
Список записей с `price` > 300
```sql
mysql> SELECT * FROM orders WHERE price > 300;
+----+----------------+-------+
| id | title          | price |
+----+----------------+-------+
|  2 | My little pony |   500 |
+----+----------------+-------+
1 row in set (0.00 sec)
```

## Задача 2

Создайте пользователя test в БД c паролем test-pass, используя:
- плагин авторизации mysql_native_password
- срок истечения пароля - 180 дней 
- количество попыток авторизации - 3 
- максимальное количество запросов в час - 100
- аттрибуты пользователя:
    - Фамилия "Pretty"
    - Имя "James"

Предоставьте привелегии пользователю `test` на операции SELECT базы `test_db`.
    
Используя таблицу INFORMATION_SCHEMA.USER_ATTRIBUTES получите данные по пользователю `test` и 
**приведите в ответе к задаче**.  

Ответ:   
Создаю пользователя test с заданными параметрами
```sql
mysql> CREATE USER 'test'@'localhost'
    -> IDENTIFIED WITH mysql_native_password BY 'test-pass'
    -> WITH MAX_QUERIES_PER_HOUR 100
    -> PASSWORD EXPIRE INTERVAL 180 DAY
    -> FAILED_LOGIN_ATTEMPTS 3
    -> ATTRIBUTE '{"fname": "Pretty", "lname": "James"}';
Query OK, 0 rows affected (0.01 sec)
```
Даю права пользователю `test` в базе `test_db` и применяем их
```sql
mysql> GRANT SELECT ON test_db.* TO 'test'@'localhost';
Query OK, 0 rows affected, 1 warning (0.03 sec)
mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.01 sec)
```
Данные по пользователю `test`
```sql
mysql> SELECT * FROM INFORMATION_SCHEMA.USER_ATTRIBUTES WHERE user='test';
+------+-----------+---------------------------------------+
| USER | HOST      | ATTRIBUTE                             |
+------+-----------+---------------------------------------+
| test | localhost | {"fname": "Pretty", "lname": "James"} |
+------+-----------+---------------------------------------+
1 row in set (0.01 sec)
```

## Задача 3

Установите профилирование `SET profiling = 1`.
Изучите вывод профилирования команд `SHOW PROFILES;`.

Исследуйте, какой `engine` используется в таблице БД `test_db` и **приведите в ответе**.

Измените `engine` и **приведите время выполнения и запрос на изменения из профайлера в ответе**:
- на `MyISAM`
- на `InnoDB`

Ответ:  
Устанавливаем `SET profiling = 1`, проверяем
```sql
mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.01 sec)
mysql> SET profiling = 1;
Query OK, 0 rows affected, 1 warning (0.00 sec)
mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.03 sec)
mysql> SHOW PROFILES;
+----------+------------+------------------+
| Query_ID | Duration   | Query            |
+----------+------------+------------------+
|        1 | 0.03060625 | FLUSH PRIVILEGES |
+----------+------------+------------------+
1 row in set, 1 warning (0.00 sec)
```
Смотрим движок таблиц в БД
```sql
mysql> SHOW TABLE STATUS FROM test_db;
+--------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+
| Name   | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time         | Check_time | Collation          | Checksum | Create_options | Comment |
+--------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+
| orders | InnoDB |      10 | Dynamic    |    5 |           3276 |       16384 |               0 |            0 |         0 |              6 | 2022-02-22 05:00:14 | 2022-02-22 05:00:14 | NULL       | utf8mb4_0900_ai_ci |     NULL |                |         |
+--------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+
1 row in set (0.00 sec)
```
Меняю движок для таблицы в БД и проверяем
```sql
mysql> ALTER TABLE orders ENGINE = MyISAM;
Query OK, 5 rows affected (0.08 sec)
Records: 5  Duplicates: 0  Warnings: 0

mysql> ALTER TABLE orders ENGINE = InnoDB;
Query OK, 5 rows affected (0.30 sec)
Records: 5  Duplicates: 0  Warnings: 0

mysql> SHOW PROFILES;
+----------+------------+------------------------------------+
| Query_ID | Duration   | Query                              |
+----------+------------+------------------------------------+
|        1 | 0.07998475 | ALTER TABLE orders ENGINE = MyISAM |
|        2 | 0.29666825 | ALTER TABLE orders ENGINE = InnoDB |
+----------+------------+------------------------------------+
2 rows in set, 1 warning (0.00 sec)
```
Время переключения на MyISAM - 0.07 сек.  
Время переключения на InnoDB - 0.2 сек.


## Задача 4 

Изучите файл `my.cnf` в директории /etc/mysql.

Измените его согласно ТЗ (движок InnoDB):
- Скорость IO важнее сохранности данных
- Нужна компрессия таблиц для экономии места на диске
- Размер буффера с незакомиченными транзакциями 1 Мб
- Буффер кеширования 30% от ОЗУ
- Размер файла логов операций 100 Мб

Приведите в ответе измененный файл `my.cnf`.  

Ответ:  
- Скорость IO важнее сохранности данных
```bash
root@7fe5f2a0504f:/# sed -i '26a innodb_flush_log_at_trx_commit = 2' /etc/mysql/my.cnf
```
- Нужна компрессия таблиц для экономии места на диске
```bash
root@7fe5f2a0504f:/# sed -i '26a innodb_file_format=Barracuda' /etc/mysql/my.cnf
```
- Размер буффера с незакомиченными транзакциями 1 Мб
```bash
root@7fe5f2a0504f:/# sed -i '26a innodb_log_buffer_size = 1M' /etc/mysql/my.cnf
```
- Буффер кеширования 30% от ОЗУ
```bash
root@7fe5f2a0504f:/# sed -i '26a key_buffer_size = 600M' /etc/mysql/my.cnf
```
- Размер файла логов операций 100 Мб
```bash
root@7fe5f2a0504f:/# sed -i '26a innodb_log_file_size = 100M' /etc/mysql/my.cnf
```
Итоговый конфиг-файл
```bash
root@7fe5f2a0504f:/# cat /etc/mysql/my.cnf
# Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

#
# The MySQL  Server configuration file.
#
# For explanations see
# http://dev.mysql.com/doc/mysql/en/server-system-variables.html

[mysqld]
pid-file        = /var/run/mysqld/mysqld.pid
socket          = /var/run/mysqld/mysqld.sock
datadir         = /var/lib/mysql
innodb_log_buffer_size = 1M
innodb_log_file_size = 100M
key_buffer_size = 600M
innodb_file_format=Barracuda
innodb_flush_log_at_trx_commit = 2

# Custom config should go here
!includedir /etc/mysql/conf.d/
```
т.к. мы используем docker-контейнер все текущие настройки удалятся. Подобный конфиг было бы отлично описать в применением подхода IaC.

<details>
  <summary>Console</summary>


С ДЗ закончили. Сворачиваем облако
```bash
mysql> \q
Bye
root@7fe5f2a0504f:/# exit
exit
[centos@node01 ~]$ exit
logout
Connection to 84.201.132.240 closed.
[gnoy@manjarokde-ws01 terraform]$ terraform destroy -auto-approve
yandex_vpc_network.default: Refreshing state... [id=enp6h36ljbvr2l2cvbo3]
yandex_vpc_subnet.default: Refreshing state... [id=e9bbj9cfhcvip2alvc3d]
yandex_compute_instance.node01: Refreshing state... [id=fhm55fa0emvcopunm0qu]
local_file.inventory: Refreshing state... [id=e503a7098c199a059267ea316100d41d29bad3da]
null_resource.wait: Refreshing state... [id=6542146339516881743]
null_resource.docker: Refreshing state... [id=2345505982686204578]
null_resource.mysql: Refreshing state... [id=2856843460866434061]
null_resource.start: Refreshing state... [id=1425382718863258983]

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  - destroy

Terraform will perform the following actions:

  # local_file.inventory will be destroyed
  - resource "local_file" "inventory" {
      - content              = <<-EOT
            # Ansible inventory containing variable values from Terraform.
            # Generated by Terraform.
            
            [nodes:children]
            node01
            
            [node01]
            node01.netology.yc ansible_host=84.201.132.240
        EOT -> null
      - directory_permission = "0777" -> null
      - file_permission      = "0777" -> null
      - filename             = "../ansible/inventory" -> null
      - id                   = "e503a7098c199a059267ea316100d41d29bad3da" -> null
    }

  # null_resource.docker will be destroyed
  - resource "null_resource" "docker" {
      - id = "2345505982686204578" -> null
    }

  # null_resource.mysql will be destroyed
  - resource "null_resource" "mysql" {
      - id = "2856843460866434061" -> null
    }

  # null_resource.start will be destroyed
  - resource "null_resource" "start" {
      - id = "1425382718863258983" -> null
    }

  # null_resource.wait will be destroyed
  - resource "null_resource" "wait" {
      - id = "6542146339516881743" -> null
    }

  # yandex_compute_instance.node01 will be destroyed
  - resource "yandex_compute_instance" "node01" {
      - allow_stopping_for_update = true -> null
      - created_at                = "2022-02-22T04:54:15Z" -> null
      - folder_id                 = "b1g27gpcstr1l1bi3a22" -> null
      - fqdn                      = "node01.netology.yc" -> null
      - hostname                  = "node01" -> null
      - id                        = "fhm55fa0emvcopunm0qu" -> null
      - labels                    = {} -> null
      - metadata                  = {
          - "ssh-keys" = <<-EOT
                centos:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDAQrqhEDvkOhgrnOksf0Q/8iHIafkADpI+dabnPVGrjfEilNcIW+WH0wPDO53nDJqPgKFE9eZ+5CpMEkMX96SoR2fmdmx80qVKGW6/5z9IMtHnzpVkAVtSDguA/JV/bMP4vwov/DsvDN+/FwJ16EwX0t3Q5VgELYw/o6I1u981CCj+VdmjE7xdf8dNI+jvHN+ho59C1TXhUBevluAjB3MhRe+j3pN6slzXgS2Dun99GvNjPVD14V6piA2V7Cb88haJ7SfzvOV7CrZfsjFZ0Q4eEKy9F3aNUiL7q0DqrFpoXCfpqM1I9D7Kt1b02UjOemAmYrmLCo/chA524gYvf1L6APuCC05u+bV7YCKiQTugVE17oFDzTu76PQ/qRtvxZGk+p4+DWSluwNQL+6oM1zEjH6anqV7QEFpoKTPU5nAKh6mV3xSNUkiJfc6qnZHKLdAOm4qozEPvx6nYw9pypaVUwK35+L4hTPt/yILerk5FT1fFuMQnOK9S4aOyisLHN2a3FHDenWOUsQszLSzrJxNNvhDqTo/fAXjqcItsUK9v0vDdhwiYydgSItoxsDEvyevySwLTkJugtwuEwVShCSPcWN8fq5FwxEV/4fhJDrOimbE+hV11k3/5JfuHoN92z5ucJgF8QLIfPkBxSjRXXEqVfhqg6JTqTWBx6l4mxE2OWQ==
            EOT
        } -> null
      - name                      = "node01" -> null
      - network_acceleration_type = "standard" -> null
      - platform_id               = "standard-v1" -> null
      - status                    = "running" -> null
      - zone                      = "ru-central1-a" -> null

      - boot_disk {
          - auto_delete = true -> null
          - device_name = "fhml5erv5dbhr82bgfg8" -> null
          - disk_id     = "fhml5erv5dbhr82bgfg8" -> null
          - mode        = "READ_WRITE" -> null

          - initialize_params {
              - block_size = 4096 -> null
              - image_id   = "fd85r12arfq9sshb8b70" -> null
              - name       = "root-node01" -> null
              - size       = 10 -> null
              - type       = "network-hdd" -> null
            }
        }

      - network_interface {
          - index              = 0 -> null
          - ip_address         = "192.168.101.11" -> null
          - ipv4               = true -> null
          - ipv6               = false -> null
          - mac_address        = "d0:0d:52:bd:40:75" -> null
          - nat                = true -> null
          - nat_ip_address     = "84.201.132.240" -> null
          - nat_ip_version     = "IPV4" -> null
          - security_group_ids = [] -> null
          - subnet_id          = "e9bbj9cfhcvip2alvc3d" -> null
        }

      - placement_policy {}

      - resources {
          - core_fraction = 5 -> null
          - cores         = 2 -> null
          - gpus          = 0 -> null
          - memory        = 2 -> null
        }

      - scheduling_policy {
          - preemptible = false -> null
        }
    }

  # yandex_vpc_network.default will be destroyed
  - resource "yandex_vpc_network" "default" {
      - created_at = "2022-02-22T04:54:13Z" -> null
      - folder_id  = "b1g27gpcstr1l1bi3a22" -> null
      - id         = "enp6h36ljbvr2l2cvbo3" -> null
      - labels     = {} -> null
      - name       = "net" -> null
      - subnet_ids = [
          - "e9bbj9cfhcvip2alvc3d",
        ] -> null
    }

  # yandex_vpc_subnet.default will be destroyed
  - resource "yandex_vpc_subnet" "default" {
      - created_at     = "2022-02-22T04:54:14Z" -> null
      - folder_id      = "b1g27gpcstr1l1bi3a22" -> null
      - id             = "e9bbj9cfhcvip2alvc3d" -> null
      - labels         = {} -> null
      - name           = "subnet" -> null
      - network_id     = "enp6h36ljbvr2l2cvbo3" -> null
      - v4_cidr_blocks = [
          - "192.168.101.0/24",
        ] -> null
      - v6_cidr_blocks = [] -> null
      - zone           = "ru-central1-a" -> null
    }

Plan: 0 to add, 0 to change, 8 to destroy.

Changes to Outputs:
  - external_ip_address_node01 = "84.201.132.240" -> null
  - internal_ip_address_node01 = "192.168.101.11" -> null
null_resource.start: Destroying... [id=1425382718863258983]
null_resource.start: Destruction complete after 1s
null_resource.mysql: Destroying... [id=2856843460866434061]
null_resource.mysql: Destruction complete after 0s
null_resource.docker: Destroying... [id=2345505982686204578]
null_resource.docker: Destruction complete after 0s
null_resource.wait: Destroying... [id=6542146339516881743]
null_resource.wait: Destruction complete after 0s
local_file.inventory: Destroying... [id=e503a7098c199a059267ea316100d41d29bad3da]
local_file.inventory: Destruction complete after 0s
yandex_compute_instance.node01: Destroying... [id=fhm55fa0emvcopunm0qu]
yandex_compute_instance.node01: Still destroying... [id=fhm55fa0emvcopunm0qu, 10s elapsed]
yandex_compute_instance.node01: Destruction complete after 18s
yandex_vpc_subnet.default: Destroying... [id=e9bbj9cfhcvip2alvc3d]
yandex_vpc_subnet.default: Destruction complete after 8s
yandex_vpc_network.default: Destroying... [id=enp6h36ljbvr2l2cvbo3]
yandex_vpc_network.default: Destruction complete after 0s

Destroy complete! Resources: 8 destroyed.
[gnoy@manjarokde-ws01 terraform]$ 
```

</details>